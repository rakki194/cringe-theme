{{ $id := .Get 0 }}

{{/* Split the content by comments */}}
{{ $content := .Inner }}
{{ $parts := split $content "<!-- linux -->" }}
{{ $winContent := index $parts 0 }}

{{ $linuxContent := "" }}
{{ $macContent := "" }}

{{ if gt (len $parts) 1 }}
  {{ $linuxParts := split (index $parts 1) "<!-- mac -->" }}
  {{ $linuxContent = index $linuxParts 0 }}
  
  {{ if gt (len $linuxParts) 1 }}
    {{ $macContent = index $linuxParts 1 }}
  {{ end }}
{{ end }}

<div class="os-instructions" data-id="{{ $id }}">
    <div class="os-tabs">
        <button class="os-tab windows os-btn-windows active" data-os="windows">Windows</button>
        <button class="os-tab linux os-btn-linux" data-os="linux">Linux</button>
        <button class="os-tab mac os-btn-mac" data-os="mac">macOS</button>
    </div>
    <div class="os-content">
        <div class="os-section os-windows active">
            {{ $winContent | markdownify }}
        </div>
        <div class="os-section os-linux">
            {{ $linuxContent | markdownify }}
        </div>
        <div class="os-section os-mac">
            {{ $macContent | markdownify }}
        </div>
    </div>
</div>

<script>
// Initialize script only once per page
if (typeof window.osInstructionsInitialized === 'undefined') {
    window.osInstructionsInitialized = true;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Function to select OS tab and show content
        function selectOSTab(container, os) {
            if (!container) return;
            
            // Get tabs and sections within this container
            const tabs = container.querySelectorAll('.os-tab');
            const sections = container.querySelectorAll('.os-section');
            
            // Hide all sections and deactivate tabs
            tabs.forEach(tab => tab.classList.remove('active'));
            sections.forEach(section => section.classList.remove('active'));
            
            // Activate selected tab
            const selectedTab = container.querySelector(`.os-tab[data-os="${os}"]`);
            if (selectedTab) selectedTab.classList.add('active');
            
            // Show selected section
            const selectedSection = container.querySelector(`.os-section.os-${os}`);
            if (selectedSection) selectedSection.classList.add('active');
        }
        
        // Get user's preferred OS or detect from system
        function getUserOS() {
            // Check if user has a stored preference
            const storedOS = localStorage.getItem('preferredOS');
            if (storedOS) return storedOS;
            
            // Otherwise, detect from user agent
            const userAgent = window.navigator.userAgent;
            if (userAgent.indexOf('Windows') !== -1) return 'windows';
            if (userAgent.indexOf('Linux') !== -1) return 'linux';
            if (userAgent.indexOf('Mac') !== -1) return 'mac';
            
            // Default to Windows if detection fails
            return 'windows';
        }
        
        // Add click handlers to all OS tabs
        document.querySelectorAll('.os-tab').forEach(button => {
            button.addEventListener('click', function() {
                const os = this.getAttribute('data-os');
                const container = this.closest('.os-instructions');
                
                if (os && container) {
                    // Select this OS in this container
                    selectOSTab(container, os);
                    
                    // Store preference
                    localStorage.setItem('preferredOS', os);
                }
            });
        });
        
        // Initial setup - select preferred OS in all containers
        const preferredOS = getUserOS();
        document.querySelectorAll('.os-instructions').forEach(container => {
            selectOSTab(container, preferredOS);
        });
    });
}
</script>

<style>
.os-instructions {
    margin: 1.5rem 0;
    border-radius: 4px;
    overflow: hidden;
    border: 1px solid var(--gray-200);
}

.os-tabs {
    display: flex;
    background-color: var(--gray-100);
    border-bottom: 1px solid var(--gray-200);
}

.os-tab {
    padding: 0.5rem 1rem;
    border: none;
    background: none;
    cursor: pointer;
    font-weight: 500;
    color: var(--gray-600);
}

.os-tab:hover {
    background-color: var(--gray-200);
}

.os-tab.active {
    background-color: white;
    color: var(--primary-color);
    border-bottom: 2px solid var(--primary-color);
}

.os-content {
    padding: 1rem;
    background-color: white;
}

.os-section {
    display: none;
}

.os-section.active {
    display: block;
}

/* Fix for nested markdown content */
.os-section p:first-child {
    margin-top: 0;
}

.os-section p:last-child {
    margin-bottom: 0;
}

.os-section pre {
    margin: 1rem 0;
}

/* Ensure code blocks are properly styled */
.os-section pre code {
    display: block;
    padding: 1rem;
    overflow-x: auto;
}

@media (prefers-color-scheme: dark) {
    .os-tabs {
        background-color: var(--gray-800);
        border-bottom: 1px solid var(--gray-700);
    }
    
    .os-tab {
        color: var(--gray-400);
    }
    
    .os-tab:hover {
        background-color: var(--gray-700);
    }
    
    .os-tab.active {
        background-color: var(--gray-900);
        color: var(--primary-color-light);
        border-bottom: 2px solid var(--primary-color-light);
    }
    
    .os-content {
        background-color: var(--gray-900);
    }
}
</style> 